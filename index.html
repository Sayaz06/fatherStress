<!doctype html>
<html lang="ms">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="theme-color" content="#111827" />
  <title>Original Wan-Law</title>
  <style>
    :root {
      --bg: #0b0f17; --card: #121826; --text: #e5e7eb;
      --muted: #9ca3af; --primary: #38bdf8; --danger: #fecaca; --border: #1f2937;
    }
    body { margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto; background:var(--bg); color:var(--text); }
    .container { max-width:860px; margin:0 auto; padding:16px; }
    .card { background:var(--card); border:1px solid var(--border); border-radius:12px; padding:16px; }
    .card-header { display:flex; justify-content:space-between; align-items:center; gap:12px; }
    .card-title { font-weight:700; font-size:18px; }
    .card-subtitle { font-size:12px; color:var(--muted); }
    .divider { height:1px; background:var(--border); margin:12px 0; }
    .btn { border:1px solid var(--border); background:transparent; color:var(--text); padding:8px 12px; border-radius:8px; cursor:pointer; }
    .btn:hover { border-color:var(--primary); color:var(--primary); }
    .btn-full { width:100%; } .btn-pill { border-radius:999px; }
    .btn-xs { padding:2px 6px; font-size:10px; }
    .section { display:grid; gap:8px; }
    .list-item { border:1px solid var(--border); border-radius:10px; padding:10px; margin-bottom:8px; cursor:pointer; }
    .toolbar { display:flex; gap:8px; margin-bottom:8px; flex-wrap:wrap; }
    .toolbar button { font-size:12px; }
    .editor { min-height:240px; border:1px solid var(--border); border-radius:8px; padding:10px; background:#0f1523; color:var(--text); }
    .mt-2 { margin-top:8px; } .mt-3 { margin-top:12px; }
  </style>
</head>
<body>
  <div id="app" class="container"></div>

  <!-- Firebase SDK (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="firebase-config.js"></script>

    <script>
    // State & helpers
    const spaRoot = document.getElementById("app");
    const APP_STATE = { route: "login", user: null, wanlaw: { topicId: null, folderId: null, noteId: null } };
    const db = firebase.firestore();

    function el(tag, opts = {}) {
      const n = document.createElement(tag);
      if (opts.className) n.className = opts.className;
      if (opts.text) n.textContent = opts.text;
      if (opts.attrs) Object.entries(opts.attrs).forEach(([k, v]) => n.setAttribute(k, v));
      if (opts.on) Object.entries(opts.on).forEach(([k, fn]) => n.addEventListener(k, fn));
      return n;
    }

    function userDoc() { return db.collection("users").doc(APP_STATE.user.uid); }
    function wanlawTopics() { return userDoc().collection("wanlaw_topics"); }
    function wanlawFolders(tid) { return wanlawTopics().doc(tid).collection("folders"); }
    function wanlawNotes(tid, fid) { return wanlawFolders(tid).doc(fid).collection("notes"); }

    function setRoute(r) { APP_STATE.route = r; render(); }
    function render() {
      if (!APP_STATE.user) return renderLogin();
      switch (APP_STATE.route) {
        case "home": return renderHome();
        case "folders": return renderFolders();
        case "note": return renderNote();
        default: return renderHome();
      }
    }

    // Login page: Email + Google
    function renderLogin() {
      const card = el("div", { className: "card" });
      const header = el("div", { className: "card-header" });
      header.appendChild(el("div", { className: "card-title", text: "Login ke Original Wan-Law" }));
      card.appendChild(header);
      card.appendChild(el("div", { className: "divider" }));

      const emailInput = el("input", { attrs: { type: "email", placeholder: "Masukkan email" } });
      const btnEmail = el("button", { className: "btn btn-full btn-pill mt-2", text: "Login dengan Email" });
      btnEmail.addEventListener("click", async () => {
        try {
          const email = emailInput.value;
          const pw = "default123"; // boleh tukar ke password sebenar
          await firebase.auth().signInWithEmailAndPassword(email, pw).catch(async () => {
            await firebase.auth().createUserWithEmailAndPassword(email, pw);
          });
        } catch (err) { alert("Gagal login email: " + err.message); }
      });

      const btnGoogle = el("button", { className: "btn btn-full btn-pill mt-2", text: "Login dengan Google" });
      btnGoogle.addEventListener("click", async () => {
        const provider = new firebase.auth.GoogleAuthProvider();
        try { await firebase.auth().signInWithPopup(provider); }
        catch (err) { alert("Gagal login Google: " + err.message); }
      });

      card.appendChild(emailInput);
      card.appendChild(btnEmail);
      card.appendChild(btnGoogle);

      spaRoot.innerHTML = "";
      spaRoot.appendChild(card);
    }

    async function renderHome() {
      const card = el("div", { className: "card" });

      const header = el("div", { className: "card-header" });
      header.appendChild(el("div", { className: "card-title", text: "Original Wan-Law" }));
      const btnLogout = el("button", { className: "btn btn-xs", text: "Logout", on: { click: async () => { await firebase.auth().signOut(); } } });
      btnLogout.style.color = "#fecaca";
      header.appendChild(btnLogout);
      card.appendChild(header);
      card.appendChild(el("div", { className: "divider" }));

      const addBtn = el("button", { className: "btn btn-full btn-pill", text: "Tambah Tajuk Baharu" });
      const list = el("div", { className: "section" });
      card.appendChild(addBtn);
      card.appendChild(list);

      spaRoot.innerHTML = "";
      spaRoot.appendChild(card);

      addBtn.addEventListener("click", async () => {
        const name = prompt("Nama Tajuk:");
        if (!name) return;
        await wanlawTopics().add({ name, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
        loadTopics();
      });

      async function loadTopics() {
        list.innerHTML = "";
        const snap = await wanlawTopics().orderBy("createdAt", "desc").get();
        if (snap.empty) {
          list.appendChild(el("div", { className: "card-subtitle", text: "Tiada tajuk. Tambah tajuk baharu." }));
          return;
        }
        snap.forEach(d => {
          const topic = { id: d.id, ...d.data() };
          const item = el("div", { className: "list-item" });

          const row = el("div", { className: "card-header" });
          row.appendChild(el("div", { className: "card-title", text: topic.name }));

          const actions = el("div");
          const btnEdit = el("button", { className: "btn btn-xs", text: "Sunting" });
          const btnDelete = el("button", { className: "btn btn-xs", text: "Padam" }); btnDelete.style.color = "#fecaca";
          actions.appendChild(btnEdit); actions.appendChild(btnDelete);
          row.appendChild(actions);
          item.appendChild(row);

          item.addEventListener("click", (e) => {
            if (e.target === btnEdit || e.target === btnDelete) return;
            APP_STATE.wanlaw.topicId = topic.id;
            setRoute("folders");
          });

          btnEdit.addEventListener("click", async (e) => {
            e.stopPropagation();
            const newName = prompt("Nama baru:", topic.name);
            if (!newName) return;
            await wanlawTopics().doc(topic.id).update({ name: newName });
            loadTopics();
          });

          btnDelete.addEventListener("click", async (e) => {
            e.stopPropagation();
            if (!confirm("Padam tajuk ini?")) return;
            await wanlawTopics().doc(topic.id).delete();
            loadTopics();
          });

          list.appendChild(item);
        });
      }
      loadTopics();
    }

      async function renderFolders() {
      const tid = APP_STATE.wanlaw.topicId;
      if (!tid) return setRoute("home");

      const topicDoc = await wanlawTopics().doc(tid).get();
      const topicName = topicDoc.exists ? topicDoc.data().name : "Original Wan-Law";

      const card = el("div", { className: "card" });

      const header = el("div", { className: "card-header" });
      header.appendChild(el("div", { className: "card-title", text: topicName }));
      const backBtn = el("button", { className: "btn btn-xs", text: "Kembali", on: { click: () => setRoute("home") } });
      header.appendChild(backBtn);
      card.appendChild(header);
      card.appendChild(el("div", { className: "divider" }));

      const addBtn = el("button", { className: "btn btn-full btn-pill", text: "Tambah Folder Baharu" });
      const list = el("div", { className: "section" });
      card.appendChild(addBtn);
      card.appendChild(list);

      spaRoot.innerHTML = "";
      spaRoot.appendChild(card);

      addBtn.addEventListener("click", async () => {
        const name = prompt("Nama Folder:");
        if (!name) return;
        await wanlawFolders(tid).add({ name, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
        loadFolders();
      });

      async function loadFolders() {
        list.innerHTML = "";
        const snap = await wanlawFolders(tid).orderBy("createdAt", "desc").get();
        if (snap.empty) {
          list.appendChild(el("div", { className: "card-subtitle", text: "Tiada folder. Tambah folder baharu." }));
          return;
        }
        snap.forEach(f => {
          const folder = { id: f.id, ...f.data() };
          const item = el("div", { className: "list-item" });

          const row = el("div", { className: "card-header" });
          row.appendChild(el("div", { className: "card-title", text: folder.name }));

          const actions = el("div");
          const btnEdit = el("button", { className: "btn btn-xs", text: "Sunting" });
          const btnDelete = el("button", { className: "btn btn-xs", text: "Padam" }); btnDelete.style.color = "#fecaca";
          actions.appendChild(btnEdit); actions.appendChild(btnDelete);
          row.appendChild(actions);
          item.appendChild(row);

          item.addEventListener("click", (e) => {
            if (e.target === btnEdit || e.target === btnDelete) return;
            APP_STATE.wanlaw.folderId = folder.id;
            setRoute("note");
          });

          btnEdit.addEventListener("click", async (e) => {
            e.stopPropagation();
            const newName = prompt("Nama baru:", folder.name);
            if (!newName) return;
            await wanlawFolders(tid).doc(folder.id).update({ name: newName });
            loadFolders();
          });

          btnDelete.addEventListener("click", async (e) => {
            e.stopPropagation();
            if (!confirm("Padam folder ini?")) return;
            await wanlawFolders(tid).doc(folder.id).delete();
            loadFolders();
          });

          list.appendChild(item);
        });
      }
      loadFolders();
    }

    async function renderNote() {
      const { topicId, folderId } = APP_STATE.wanlaw;
      if (!topicId || !folderId) return setRoute("home");

      // Ensure note document exists (single note per folder)
      const notesCol = wanlawNotes(topicId, folderId);
      let noteSnap = await notesCol.limit(1).get();
      let noteRef;
      if (noteSnap.empty) {
        noteRef = await notesCol.add({
          content: "",
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
      } else {
        noteRef = notesCol.doc(noteSnap.docs[0].id);
      }

      const docSnap = await noteRef.get();
      const data = docSnap.exists ? docSnap.data() : { content: "" };

      const card = el("div", { className: "card" });
      const header = el("div", { className: "card-header" });
      header.appendChild(el("div", { className: "card-title", text: "Nota Folder" }));
      const backBtn = el("button", { className: "btn btn-xs", text: "Kembali", on: { click: () => setRoute("folders") } });
      header.appendChild(backBtn);
      card.appendChild(header);
      card.appendChild(el("div", { className: "divider" }));

      // Toolbar for formatting
      const toolbar = el("div", { className: "toolbar" });
      const btnBold = el("button", { className: "btn btn-xs", text: "Bold" });
      const btnUnderline = el("button", { className: "btn btn-xs", text: "Underline" });
      const btnHighlight = el("button", { className: "btn btn-xs", text: "Highlight" });
      const colorInput = el("input", { attrs: { type: "color" } });
      const emojiBtn = el("button", { className: "btn btn-xs", text: "ðŸ˜€ Emoji" });

      toolbar.appendChild(btnBold);
      toolbar.appendChild(btnUnderline);
      toolbar.appendChild(btnHighlight);
      toolbar.appendChild(colorInput);
      toolbar.appendChild(emojiBtn);

      // Editable area
      const editor = el("div", { className: "editor", attrs: { contenteditable: "true" } });
      editor.innerHTML = data.content || "";

      // Apply formatting commands
      btnBold.addEventListener("click", () => document.execCommand("bold"));
      btnUnderline.addEventListener("click", () => document.execCommand("underline"));
      btnHighlight.addEventListener("click", () => document.execCommand("backColor", false, "#fde68a"));
      colorInput.addEventListener("input", (e) => document.execCommand("foreColor", false, e.target.value));
      emojiBtn.addEventListener("click", () => {
        editor.focus();
        document.execCommand("insertText", false, " ðŸ˜€ ");
      });

      card.appendChild(toolbar);
      card.appendChild(editor);

      const hint = el("div", { className: "card-subtitle mt-2", text: "Perubahan disimpan automatik ke cloud (Firestore)." });
      card.appendChild(hint);

      spaRoot.innerHTML = "";
      spaRoot.appendChild(card);

      // Auto-save (debounce)
      let saveTimeout = null;
      function scheduleSave() {
        if (saveTimeout) clearTimeout(saveTimeout);
        saveTimeout = setTimeout(async () => {
          try {
            await noteRef.update({
              content: editor.innerHTML,
              updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
          } catch (err) {
            alert("Gagal simpan perubahan: " + err.message);
          }
        }, 600);
      }
      editor.addEventListener("input", scheduleSave);
    }

    // Auth persistence and route boot
    firebase.auth().onAuthStateChanged((user) => {
      APP_STATE.user = user || null;
      if (user) {
        if (APP_STATE.route === "login") setRoute("home");
        else render();
      } else {
        setRoute("login");
      }
    });
  </script>

  <!-- Service worker register -->
  <script>
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("service-worker.js", { scope: "./" });
    }
  </script>
</body>
</html>

